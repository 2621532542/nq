var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,t,s)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,__spreadValues=(e,t)=>{for(var s in t||(t={}))__hasOwnProp.call(t,s)&&__defNormalProp(e,s,t[s]);if(__getOwnPropSymbols)for(var s of __getOwnPropSymbols(t))__propIsEnum.call(t,s)&&__defNormalProp(e,s,t[s]);return e},__spreadProps=(e,t)=>__defProps(e,__getOwnPropDescs(t));!function(){"use strict";const e={analyzeCount:0,totalAnalyzeTime:0,avgAnalyzeTime:0,maxAnalyzeTime:0,minAnalyzeTime:1/0,dfsCallCount:0,dfsCacheHits:0,dfsCacheMisses:0,wildCardPruneCount:0,sevenPairsChecks:0,sevenPairsHits:0,singleSuitChecks:0,singleSuitHits:0,lastAnalyzeTime:0,lastHandSize:0,lastCacheHitRate:"0%",recordAnalysis(e,t){this.analyzeCount++,this.totalAnalyzeTime+=e,this.avgAnalyzeTime=this.totalAnalyzeTime/this.analyzeCount,this.maxAnalyzeTime=Math.max(this.maxAnalyzeTime,e),this.minAnalyzeTime=Math.min(this.minAnalyzeTime,e),this.lastAnalyzeTime=e,this.lastHandSize=t;const s=this.dfsCacheHits+this.dfsCacheMisses;this.lastCacheHitRate=s>0?(this.dfsCacheHits/s*100).toFixed(1)+"%":"0%"},reset(){this.analyzeCount=0,this.totalAnalyzeTime=0,this.avgAnalyzeTime=0,this.maxAnalyzeTime=0,this.minAnalyzeTime=1/0,this.dfsCallCount=0,this.dfsCacheHits=0,this.dfsCacheMisses=0,this.wildCardPruneCount=0,this.sevenPairsChecks=0,this.sevenPairsHits=0,this.singleSuitChecks=0,this.singleSuitHits=0,this.lastAnalyzeTime=0,this.lastHandSize=0,this.lastCacheHitRate="0%"},getReport(){return{summary:{analyzeCount:this.analyzeCount,avgTime:this.avgAnalyzeTime.toFixed(2)+"ms",maxTime:this.maxAnalyzeTime.toFixed(2)+"ms",minTime:this.minAnalyzeTime===1/0?"N/A":this.minAnalyzeTime.toFixed(2)+"ms"},dfs:{calls:this.dfsCallCount,cacheHits:this.dfsCacheHits,cacheMisses:this.dfsCacheMisses,hitRate:this.lastCacheHitRate},optimizations:{wildCardPrunes:this.wildCardPruneCount,sevenPairs:`${this.sevenPairsHits}/${this.sevenPairsChecks}`,singleSuit:`${this.singleSuitHits}/${this.singleSuitChecks}`},last:{time:this.lastAnalyzeTime.toFixed(2)+"ms",handSize:this.lastHandSize,cacheHitRate:this.lastCacheHitRate}}}},t=0,s=1,n=2,a=4,r=5,i=7,o=8,l=9,c=1,d=2,u=3;class f{constructor(e){this.type=e,this.useCards=[],this.laiZiCards=[]}}class h{constructor(e,t){this.key=e,this.value=t}}class C{constructor(){this.canPlayCards=[],this.needCards=[],this.tingCount=0,this.round=0,this.type=t,this.bestPlayCard=0,this.needCardGroups=[],this.gang=[]}}class p{constructor(){this.playCardGroups=[],this.userCardCount=0,this.laiZiCardCount=0,this.laiZiCount=0,this.may=new Map,this.must=[],this.all=new Map}}function y(e,t){if(0===t)return[[]];if(0===e.length)return[];const[s,...n]=e,a=y(n,t),r=y(n,t-1).map(e=>[s,...e]);return a.concat(r)}function g(e){return 35===e}function m(e,t,s){const n=function(e,t=0){let s=BigInt("0");for(let n=t;n<39;n++)if(e[n]>0){const a=BigInt(3*(n-t));s|=BigInt(e[n])<<a}return s}(e,t);return`${s?"1":"0"}:${n.toString(36)}`}function w(e){if(e.length<2){if(1===e.length){const t=e[0],s=[];return s.push(t),t<30&&(t%10>1&&s.push(t-1),t%10<9&&s.push(t+1)),s}return[]}const[t,s]=e,n=s-t,a=[];return t<30&&s<30&&(1===n?(t%10>1&&a.push(t-1),s%10<9&&a.push(s+1)):2===n&&a.push(t+1)),a}function P(e,t,s){for(const n of e)if(n.useCards.includes(t)){const a=[...e],r=a.indexOf(n);a.splice(r,1);const i=[...n.useCards];i.splice(i.indexOf(t),1);const o=w(i),l=o.indexOf(t);l>-1&&o.splice(l,1);for(const e of o)s.add(e),P(a,e,s)}}function z(e){const t=Array(39).fill(0);for(const s of e)g(s)||t[s]++;return _=new Map,T(t,1,!1)}let _=null;function A(e,t,s){return m(e,t,s)}function M(e){return e.map(e=>e.map(e=>{const t=new f(e.type);return t.useCards=[...e.useCards],t.laiZiCards=[...e.laiZiCards],t}))}function b(e,t,s){if(0===t.length)s.push([e]);else for(const n of t)n.push(e),s.push(n)}function T(t,s,n){for(;s<38&&0===t[s];)s++;if(s>=38)return[[]];if(e.dfsCallCount++,_){const a=A(t,s,n),r=_.get(a);if(r)return e.dfsCacheHits++,M(r);e.dfsCacheMisses++}if(s>=30||s%10==9||0===t[s+1]&&0===t[s+2]){const e=Z(t,s,n);if(_){const a=A(t,s,n);_.set(a,M(e))}return e}const a=[],r=new f(c),i=[];for(let e=0;e<3;e++){const n=s+e;t[n]>0?(t[n]--,i.push(n),r.useCards.push(n)):2===e&&s%10==8?r.laiZiCards.push(s-1):r.laiZiCards.push(n)}if(0===r.laiZiCards.length&&s%10>1){const e=new f(c);e.useCards=[s,s+1],e.laiZiCards.push(s-1),t[s+2]++;const r=T(t,s,n);t[s+2]--,b(e,r,a)}b(r,T(t,s,n),a);for(const e of i)t[e]++;const o=Z(t,s,n),l=a.concat(o);if(_){const e=A(t,s,n);_.set(e,M(l))}return l}function Z(e,t,s){const n=e[t];if(0===n)return[];const a=[];if(e[t]=0,4===n){const a=new f(u);a.useCards.push(t,t,t),e[t]=1;const r=T(e,t,s);e[t]=0;const i=function(e,t){if(0===t.length)return[[e]];for(const s of t)s.push(e);return t}(a,r);return e[t]=n,i}if(3===n){const n=new f(u);if(n.useCards.push(t,t,t),b(n,T(e,t+1,s),a),!s){const s=new f(d);s.useCards.push(t,t),e[t]=1;const n=T(e,t,!0);e[t]=0,b(s,n,a)}}else if(2===n){const n=new f(u);if(n.useCards.push(t,t),n.laiZiCards.push(t),b(n,T(e,t+1,s),a),!s){const s=new f(d);s.useCards.push(t,t),b(s,T(e,t+1,!0),a)}}else if(1===n){const n=new f(u);if(n.useCards.push(t),n.laiZiCards.push(t,t),b(n,T(e,t+1,s),a),!s){const s=new f(d);s.useCards.push(t),s.laiZiCards.push(t),b(s,T(e,t+1,!0),a)}}return e[t]=n,a}function v(e,t){let n=0;[1,4,7,10,13].includes(e.length)&&(n=1);const a=Math.floor(e.length/3)+1,r=Array(39).fill(0);let f=0;for(const s of e)g(s)?f++:s>=0&&s<39&&r[s]++;if(f===e.length){const e=new C;return e.type=o,e}const h=z(e);h.sort((e,t)=>e.length-t.length);let m=14;const _=[];for(const s of h){let e=0;const t=s.length-a,n=new Map;let r=!1;const i=[],o=new Map,l=new Map;let u=0;for(const a of s)u++,e+=a.laiZiCards.length,a.id=u,a.laiZiCards.length>0&&o.set(a.id,a),a.type!==d?(l.set(a.id,a),a.laiZiCards.length>0?n.set(a.id,a):0===a.laiZiCards.length&&a.type===c&&i.push(...a.useCards)):r=!0;if(e===f){const e=new C;return e.round=0,e}if(r)if(t===o.size||0===n.size&&t===o.size||0===t){const t=new p;t.playCardGroups=[],t.userCardCount=0,t.laiZiCardCount=0,t.laiZiCount=e,t.may=new Map(o),t.must=i,t.all=l,_.push(t),m=Math.min(m,e)}else if(t>0){const s=y(Array.from(n.values()),t);for(const t of s){let s=0,n=0;const a=new Map(o),r=new Map(l);for(const e of t)s+=e.useCards.length,n+=e.laiZiCards.length,a.delete(e.id),r.delete(e.id);m=Math.min(m,s);const c=new p;c.playCardGroups=t,c.userCardCount=s,c.laiZiCardCount=n,c.laiZiCount=e,c.may=a,c.must=i,c.all=r,_.push(c)}}}const A=new Map,M=new Set;let b=0;const T=[];for(const s of _){const e=m;if(n>0&&1===m&&0===s.playCardGroups.length&&(m=0),s.userCardCount<=e&&s.laiZiCount-s.laiZiCardCount===s.userCardCount+n+f){for(const t of s.playCardGroups)for(const e of t.useCards)A.set(e,(A.get(e)||0)+1);const e=new Set;for(const t of s.may.values())if(e.add(...t.laiZiCards),t.useCards[0]<30){const n=Math.floor(t.useCards[0]/10),a=[];for(const e of s.all.values())e.id!==t.id&&Math.floor(e.useCards[0]/10)===n&&e.type!==u&&a.push(e);if(t.type===c){if(1===t.laiZiCards.length){const s=w(t.useCards);for(const t of s)e.add(t),P(a,t,e)}}else if(t.type===d){if(1===t.laiZiCards.length){let n=0;for(const[e,t]of s.may.entries())t.type!==d&&(n+=t.laiZiCards.length);if(n<f){for(let t=0;t<3;t++)for(let s=1;s<=9;s++)e.add(10*t+s);for(let t=31;t<=37;t++)e.add(t);e.add(35)}P(a,t.useCards[0],e)}}else if(t.type===u&&2===t.laiZiCards.length){const s=t.useCards[0],n=[],r=s%10;r-2>0&&n.push(s-2),r-1>0&&n.push(s-1),r+1<10&&n.push(s+1),r+2<10&&n.push(s+2);for(const t of n)e.add(t),P(a,t,e)}}for(const t of e)r[t]<4?M.add(t):b=t;T.push(s)}}if(f>0&&n>0){let e=!1;for(const t of h){let s=0,n=!1;for(const e of t)s+=e.laiZiCards.length,e.type===d&&(n=!0);if(n){let s=0;for(const e of t)e.type!==d&&(s+=e.laiZiCards.length);if(s<f){e=!0;break}}else if(s<f){e=!0;break}}if(e){for(let e=0;e<3;e++)for(let t=1;t<=9;t++){const s=10*e+t;r[s]<4&&M.add(s)}for(let e=31;e<=37;e++)r[e]<4&&M.add(e);M.add(35)}}const Z=new C;if(Z.targetResults=T,b>0&&0!==m)Z.type=l,Z.needCards=[b],Z.tingCount=t[b]||0;else{Z.needCards=Array.from(M),Z.needCards.sort((e,t)=>e-t),Z.canPlayCards=Array.from(A.keys());let e=0;for(const s of Z.needCards)e+=t[s]||0;Z.tingCount=e,n>0?(Z.type=s,A.size>0&&(Z.type=i)):m>0&&(Z.type=i),Z.round=m}return Z}function k(i,c){const d=performance.now();if([3,6,9,12].includes(i.length)){const t=new C;return t.type=n,e.recordAnalysis(performance.now()-d,i.length),t}if(13===i.length){e.sevenPairsChecks++;const t=function(e,t){if(13!==e.length)return null;const n=new Map;let a=0;for(const s of e)g(s)?a++:n.set(s,(n.get(s)||0)+1);let r=0;const i=[];for(const[s,o]of n)(1===o||3===o)&&(r++,i.push(s));if(r<=a){const e=new C;e.type=s;const o=[];if(a>r)for(let s=1;s<=29;s++)s%10>=1&&s%10<=9&&(n.get(s)||0)<4&&(t[s]||0)>0&&o.push(s);else for(const s of i)(t[s]||0)>0&&o.push(s);e.needCards=o.sort((e,t)=>e-t);let l=0;for(const s of o)l+=t[s]||0;return e.tingCount=l,e.round=0,e}return null}(i,c);t&&e.sevenPairsHits++}(function(e){let t=-1;for(const s of e){if(g(s))continue;const e=Math.floor(s/10);if(!(e>=3))if(-1===t)t=e;else if(t!==e)return!1}return-1!==t})(i)&&(e.singleSuitChecks++,e.singleSuitHits++);const u=v(i,c);if(u.type===o||u.type===l)return e.recordAnalysis(performance.now()-d,i.length),u;if([1,4,7,10,13].includes(i.length))return 13===i.length&&(u.round=0,u.needCards&&u.needCards.length>0?u.type=s:u.type=t),u.needCardGroups=[],u.canPlayCards=[],e.recordAnalysis(performance.now()-d,i.length),u;if(0===u.round)return u.type=a,e.recordAnalysis(performance.now()-d,i.length),u;if(u.canPlayCards&&u.canPlayCards.length>0){const t=Array(39).fill(0);for(const e of i)g(e)||t[e]++;const s=[];for(const e of u.canPlayCards||[])if(4===t[e])u.type=l,u.gang=u.gang||[],u.gang.push(e);else if(u.type!==l){const t=[...i],n=t.indexOf(e);t.splice(n,1);const a=v(t,c);let r=0;if(a.needCards&&0!==a.needCards.length)for(const e of a.needCards||[])r+=c[e];else{a.needCards=[...u.needCards];for(const e of a.needCards)r+=c[e]}a.tingCount=r,a.bestPlayCard=e,s.push(a)}if(u.type===l)return u.needCards=u.gang,e.recordAnalysis(performance.now()-d,i.length),u;s.sort((e,s)=>{const n=s.needCards?s.needCards.length:0,a=e.needCards?e.needCards.length:0;if(n!==a)return n-a;const r=s.tingCount||0,i=e.tingCount||0;if(r!==i)return r-i;const o=(t[s.bestPlayCard-1]||0)+(t[s.bestPlayCard+1]||0),l=(t[e.bestPlayCard-1]||0)+(t[e.bestPlayCard+1]||0);return o!==l?l-o:Math.abs(s.bestPlayCard%10-5)-Math.abs(e.bestPlayCard%10-5)});const n=[];for(const e of s){const t=new h;t.key=e.bestPlayCard,t.value=[...e.needCards||[]],t.tingCount=e.tingCount||0,t.round=e.round||0,n.push(t)}u.needCardGroups=n,u.type=r,u.needCardGroups.length>0&&(u.bestPlayCard=u.needCardGroups[0].key)}return e.recordAnalysis(performance.now()-d,i.length),u}function H(e){return{not_ready:"无法胡牌",ready:"听牌",xiaoxianggong:"小相公",winning:"已胡牌",unknown:"未知状态"}[e]||"未知状态"}function x(e){const t=(e.value||[]).length,s=e.tingCount||0,n=e.round||0;return n>=2?`可进${n}听，听${t}门${s}张`:`可听${t}门${s}张`}function S(e,c=!1,d="loji"){const u=function(e){switch(e){case t:case o:return"not_ready";case s:case r:case i:case l:return"ready";case n:return"xiaoxianggong";case a:return"winning";default:return"unknown"}}(e.type);return{status:u,statusCode:e.type,statusText:H(u),tingCards:e.needCards||[],tingCount:e.tingCount||0,recommendations:(f=e.needCardGroups||[],f&&0!==f.length?f.map((e,t)=>({id:t+1,discardTile:e.key,waitingTiles:e.value||[],waitingCount:e.tingCount||0,round:e.round||0,priority:t+1,description:x(e)})):[]),gangCards:e.gang||[],metadata:{round:e.round||0,originalType:e.type,algorithm:d,cached:c,timestamp:Date.now(),canPlayCards:e.canPlayCards||[]}};var f}const O=new class{constructor(e=2e3){this.cache=new Map,this.maxSize=e}getCacheKey(e){return[...e].sort((e,t)=>e-t).join(",")}get(e){const t=this.getCacheKey(e);return this.cache.get(t)}set(e,t){const s=this.getCacheKey(e);if(this.cache.size>=this.maxSize){const e=this.cache.keys().next().value;this.cache.delete(e)}this.cache.set(s,__spreadProps(__spreadValues({},t),{cached:!0,timestamp:Date.now()}))}clear(){this.cache.clear()}};self.onmessage=function(e){const{id:t,type:s,payload:n}=e.data;try{switch(s){case"analyze":{const{cards:e,cardMap:s,useCache:a}=n;if(!1!==a){const s=O.get(e);if(s)return void self.postMessage({id:t,type:"result",payload:S(s,!0,"loji-worker")})}const r=k(e,s);!1!==a&&O.set(e,r),self.postMessage({id:t,type:"result",payload:S(r,!1,"loji-worker")});break}case"clearCache":O.clear(),self.postMessage({id:t,type:"result",payload:{success:!0}});break;default:throw new Error(`Unknown message type: ${s}`)}}catch(a){self.postMessage({id:t,type:"error",payload:{message:a.message,stack:a.stack}})}},self.postMessage({type:"ready"})}();
