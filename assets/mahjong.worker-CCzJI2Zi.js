var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,t,n)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,__spreadValues=(e,t)=>{for(var n in t||(t={}))__hasOwnProp.call(t,n)&&__defNormalProp(e,n,t[n]);if(__getOwnPropSymbols)for(var n of __getOwnPropSymbols(t))__propIsEnum.call(t,n)&&__defNormalProp(e,n,t[n]);return e},__spreadProps=(e,t)=>__defProps(e,__getOwnPropDescs(t));!function(){"use strict";const e={analyzeCount:0,totalAnalyzeTime:0,avgAnalyzeTime:0,maxAnalyzeTime:0,minAnalyzeTime:1/0,dfsCallCount:0,dfsCacheHits:0,dfsCacheMisses:0,wildCardPruneCount:0,sevenPairsChecks:0,sevenPairsHits:0,singleSuitChecks:0,singleSuitHits:0,lastAnalyzeTime:0,lastHandSize:0,lastCacheHitRate:"0%",recordAnalysis(e,t){this.analyzeCount++,this.totalAnalyzeTime+=e,this.avgAnalyzeTime=this.totalAnalyzeTime/this.analyzeCount,this.maxAnalyzeTime=Math.max(this.maxAnalyzeTime,e),this.minAnalyzeTime=Math.min(this.minAnalyzeTime,e),this.lastAnalyzeTime=e,this.lastHandSize=t;const n=this.dfsCacheHits+this.dfsCacheMisses;this.lastCacheHitRate=n>0?(this.dfsCacheHits/n*100).toFixed(1)+"%":"0%"},reset(){this.analyzeCount=0,this.totalAnalyzeTime=0,this.avgAnalyzeTime=0,this.maxAnalyzeTime=0,this.minAnalyzeTime=1/0,this.dfsCallCount=0,this.dfsCacheHits=0,this.dfsCacheMisses=0,this.wildCardPruneCount=0,this.sevenPairsChecks=0,this.sevenPairsHits=0,this.singleSuitChecks=0,this.singleSuitHits=0,this.lastAnalyzeTime=0,this.lastHandSize=0,this.lastCacheHitRate="0%"},getReport(){return{summary:{analyzeCount:this.analyzeCount,avgTime:this.avgAnalyzeTime.toFixed(2)+"ms",maxTime:this.maxAnalyzeTime.toFixed(2)+"ms",minTime:this.minAnalyzeTime===1/0?"N/A":this.minAnalyzeTime.toFixed(2)+"ms"},dfs:{calls:this.dfsCallCount,cacheHits:this.dfsCacheHits,cacheMisses:this.dfsCacheMisses,hitRate:this.lastCacheHitRate},optimizations:{wildCardPrunes:this.wildCardPruneCount,sevenPairs:`${this.sevenPairsHits}/${this.sevenPairsChecks}`,singleSuit:`${this.singleSuitHits}/${this.singleSuitChecks}`},last:{time:this.lastAnalyzeTime.toFixed(2)+"ms",handSize:this.lastHandSize,cacheHitRate:this.lastCacheHitRate}}}},t=0,n=1,s=2,a=4,r=5,o=7,i=8,c=9,l=1,u=2,d=3;class f{constructor(e){this.type=e,this.useCards=[],this.laiZiCards=[]}}class h{constructor(e,t){this.key=e,this.value=t}}class p{constructor(){this.canPlayCards=[],this.needCards=[],this.tingCount=0,this.round=0,this.type=t,this.bestPlayCard=0,this.needCardGroups=[],this.gang=[]}}class C{constructor(){this.playCardGroups=[],this.userCardCount=0,this.laiZiCardCount=0,this.laiZiCount=0,this.may=new Map,this.must=[],this.all=new Map}}function y(e,t){if(0===t)return[[]];if(0===e.length)return[];const[n,...s]=e,a=y(s,t),r=y(s,t-1).map(e=>[n,...e]);return a.concat(r)}function g(e){return 35===e}function m(e,t,n){const s=function(e,t=0){let n=BigInt("0");for(let s=t;s<39;s++)if(e[s]>0){const a=BigInt(3*(s-t));n|=BigInt(e[s])<<a}return n}(e,t);return`${n?"1":"0"}:${s.toString(36)}`}function w(e){if(e.length<2){if(1===e.length){const t=e[0],n=[];return n.push(t),t<30&&(t%10>1&&n.push(t-1),t%10<9&&n.push(t+1)),n}return[]}const[t,n]=e,s=n-t,a=[];return t<30&&n<30&&(1===s?(t%10>1&&a.push(t-1),n%10<9&&a.push(n+1)):2===s&&a.push(t+1)),a}function b(e,t,n){for(const s of e)if(s.useCards.includes(t)){const a=[...e],r=a.indexOf(s);a.splice(r,1);const o=[...s.useCards];o.splice(o.indexOf(t),1);const i=w(o),c=i.indexOf(t);c>-1&&i.splice(c,1);for(const e of i)n.add(e),b(a,e,n)}}function P(e){const t=Array(39).fill(0);for(const n of e)g(n)||t[n]++;return x=new Map,M(t,1,!1)}let x=null;function S(e,t,n){return m(e,t,n)}function k(e){return e.map(e=>e.map(e=>{const t=new f(e.type);return t.useCards=[...e.useCards],t.laiZiCards=[...e.laiZiCards],t}))}function z(e,t,n){if(0===t.length)n.push([e]);else for(const s of t)s.push(e),n.push(s)}function M(t,n,s){for(;n<38&&0===t[n];)n++;if(n>=38)return[[]];if(e.dfsCallCount++,x){const a=S(t,n,s),r=x.get(a);if(r)return e.dfsCacheHits++,k(r);e.dfsCacheMisses++}if(n>=30||n%10==9||0===t[n+1]&&0===t[n+2]){const e=_(t,n,s);if(x){const a=S(t,n,s);x.set(a,k(e))}return e}const a=[],r=new f(l),o=[];for(let e=0;e<3;e++){const s=n+e;t[s]>0?(t[s]--,o.push(s),r.useCards.push(s)):2===e&&n%10==8?r.laiZiCards.push(n-1):r.laiZiCards.push(s)}if(0===r.laiZiCards.length&&n%10>1){const e=new f(l);e.useCards=[n,n+1],e.laiZiCards.push(n-1),t[n+2]++;const r=M(t,n,s);t[n+2]--,z(e,r,a)}z(r,M(t,n,s),a);for(const e of o)t[e]++;const i=_(t,n,s),c=a.concat(i);if(x){const e=S(t,n,s);x.set(e,k(c))}return c}function _(e,t,n){const s=e[t];if(0===s)return[];const a=[];if(e[t]=0,4===s){const a=new f(d);a.useCards.push(t,t,t),e[t]=1;const r=M(e,t,n);e[t]=0;const o=function(e,t){if(0===t.length)return[[e]];for(const n of t)n.push(e);return t}(a,r);return e[t]=s,o}if(3===s){const s=new f(d);if(s.useCards.push(t,t,t),z(s,M(e,t+1,n),a),!n){const n=new f(u);n.useCards.push(t,t),e[t]=1;const s=M(e,t,!0);e[t]=0,z(n,s,a)}}else if(2===s){const s=new f(d);if(s.useCards.push(t,t),s.laiZiCards.push(t),z(s,M(e,t+1,n),a),!n){const n=new f(u);n.useCards.push(t,t),z(n,M(e,t+1,!0),a)}}else if(1===s){const s=new f(d);if(s.useCards.push(t),s.laiZiCards.push(t,t),z(s,M(e,t+1,n),a),!n){const n=new f(u);n.useCards.push(t),n.laiZiCards.push(t),z(n,M(e,t+1,!0),a)}}return e[t]=s,a}function A(e,t){let s=0;[1,4,7,10,13].includes(e.length)&&(s=1);const a=Math.floor(e.length/3)+1,r=Array(39).fill(0);let f=0;for(const n of e)g(n)?f++:n>=0&&n<39&&r[n]++;if(f===e.length){const e=new p;return e.type=i,e}const h=P(e);h.sort((e,t)=>e.length-t.length);let m=14;const x=[];for(const n of h){let e=0;const t=n.length-a,s=new Map;let r=!1;const o=[],i=new Map,c=new Map;let d=0;for(const a of n)d++,e+=a.laiZiCards.length,a.id=d,a.laiZiCards.length>0&&i.set(a.id,a),a.type!==u?(c.set(a.id,a),a.laiZiCards.length>0?s.set(a.id,a):0===a.laiZiCards.length&&a.type===l&&o.push(...a.useCards)):r=!0;if(e===f){const e=new p;return e.round=0,e}if(r)if(t===i.size||0===s.size&&t===i.size||0===t){const t=new C;t.playCardGroups=[],t.userCardCount=0,t.laiZiCardCount=0,t.laiZiCount=e,t.may=new Map(i),t.must=o,t.all=c,x.push(t),m=Math.min(m,e)}else if(t>0){const n=y(Array.from(s.values()),t);for(const t of n){let n=0,s=0;const a=new Map(i),r=new Map(c);for(const e of t)n+=e.useCards.length,s+=e.laiZiCards.length,a.delete(e.id),r.delete(e.id);m=Math.min(m,n);const l=new C;l.playCardGroups=t,l.userCardCount=n,l.laiZiCardCount=s,l.laiZiCount=e,l.may=a,l.must=o,l.all=r,x.push(l)}}}const S=new Map,k=new Set;let z=0;const M=[];for(const n of x){const e=m;if(s>0&&1===m&&0===n.playCardGroups.length&&(m=0),n.userCardCount<=e&&n.laiZiCount-n.laiZiCardCount===n.userCardCount+s+f){for(const t of n.playCardGroups)for(const e of t.useCards)S.set(e,(S.get(e)||0)+1);const e=new Set;for(const t of n.may.values())if(e.add(...t.laiZiCards),t.useCards[0]<30){const s=Math.floor(t.useCards[0]/10),a=[];for(const e of n.all.values())e.id!==t.id&&Math.floor(e.useCards[0]/10)===s&&e.type!==d&&a.push(e);if(t.type===l){if(1===t.laiZiCards.length){const n=w(t.useCards);for(const t of n)e.add(t),b(a,t,e)}}else if(t.type===u){if(1===t.laiZiCards.length){let s=0;for(const[e,t]of n.may.entries())t.type!==u&&(s+=t.laiZiCards.length);if(s<f){for(let t=0;t<3;t++)for(let n=1;n<=9;n++)e.add(10*t+n);for(let t=31;t<=37;t++)e.add(t);e.add(35)}b(a,t.useCards[0],e)}}else if(t.type===d&&2===t.laiZiCards.length){const n=t.useCards[0],s=[],r=n%10;r-2>0&&s.push(n-2),r-1>0&&s.push(n-1),r+1<10&&s.push(n+1),r+2<10&&s.push(n+2);for(const t of s)e.add(t),b(a,t,e)}}for(const t of e)r[t]<4?k.add(t):z=t;M.push(n)}}if(f>0&&s>0){let e=!1;for(const t of h){let n=0,s=!1;for(const e of t)n+=e.laiZiCards.length,e.type===u&&(s=!0);if(s){let n=0;for(const e of t)e.type!==u&&(n+=e.laiZiCards.length);if(n<f){e=!0;break}}else if(n<f){e=!0;break}}if(e){for(let e=0;e<3;e++)for(let t=1;t<=9;t++){const n=10*e+t;r[n]<4&&k.add(n)}for(let e=31;e<=37;e++)r[e]<4&&k.add(e);k.add(35)}}const _=new p;if(_.targetResults=M,z>0&&0!==m)_.type=c,_.needCards=[z],_.tingCount=t[z]||0;else{_.needCards=Array.from(k),_.needCards.sort((e,t)=>e-t),_.canPlayCards=Array.from(S.keys());let e=0;for(const n of _.needCards)e+=t[n]||0;_.tingCount=e,s>0?(_.type=n,S.size>0&&(_.type=o)):m>0&&(_.type=o),_.round=m}return _}function v(e,t,n,s=!1){const a=[...t];a[e]=Math.max(0,a[e]-1);let r=0;const o=[],i=[];for(let c=1;c<=38;c++){if(1!==a[c])continue;if(g(c))continue;const e=c%10;if(e>=3){const e=c-2;if(2===a[e]){const t=c-1;a[t]<3&&(r+=2,i.push({draw:t,isolated:c,pair:e}))}}if(e>=2&&e<=8){const t=c-1;2===a[t]&&(r+=2,e>=3&&i.push({draw:c-2,isolated:c,pair:t}),e<=7&&i.push({draw:c+1,isolated:c,pair:t}))}if(e>=2&&e<=8){const t=c+1;2===a[t]&&(r+=2,e>=2&&i.push({draw:c-1,isolated:c,pair:t}),e<=8&&i.push({draw:c+2,isolated:c,pair:t}))}if(e<=7){const e=c+2;if(2===a[e]){const t=c+1;a[t]<3&&(r+=2,i.push({draw:t,isolated:c,pair:e}))}}for(let t=-2;t<=2;t++){if(0===t)continue;const e=c+t;e>=1&&e<=38&&3===a[e]&&(r-=1)}}if(1===t[e]){const n=e%10;if(n>=1&&n<=7){if(2===t[e+1]){const s=e+2;n<=7&&t[s]<3&&o.push({draw:s,reason:`打${T(e)}会错失${T(s)}的改进机会`})}}if(n>=3&&n<=9){if(2===t[e-1]){const s=e-2;n>=3&&t[s]<3&&o.push({draw:s,reason:`打${T(e)}会错失${T(s)}的改进机会`})}}}return s?{value:r,missedDraws:o,goodDraws:i}:r}function T(e){if(e>=31)return"红中";return e%10+["万","筒","条"][Math.floor(e/10)]}function O(e,t){const n=t[e]||0,s=e%10;let a=0,r="none",o=!1;return n>=3?(a=-10,r="triplet"):2===n?(a=-6,r="pair",s>=2&&(t[e-1]||0)>=1&&(o=!0),s<=8&&(t[e+1]||0)>=1&&(o=!0),s>=3&&(t[e-2]||0)>=1&&(o=!0),s<=7&&(t[e+2]||0)>=1&&(o=!0)):1===n&&(s>=2&&1===(t[e-1]||0)&&(s>=3&&s<=8?(a=-8,r="two-sided"):(a=-4,r="edge")),s<=8&&1===(t[e+1]||0)&&(s>=2&&s<=7?a>-8&&(a=-8,r="two-sided"):a>-4&&(a=-4,r="edge")),s>=3&&1===(t[e-2]||0)&&a>-3&&(a=-3,r="middle"),s<=7&&1===(t[e+2]||0)&&a>-3&&(a=-3,r="middle")),{breakValue:a,partnerType:r,canCombine:o}}function V(l,u,d={}){var f;const C=performance.now();if([3,6,9,12].includes(l.length)){const t=new p;return t.type=s,e.recordAnalysis(performance.now()-C,l.length),t}if(13===l.length){e.sevenPairsChecks++;const t=function(e,t){if(13!==e.length)return null;const s=new Map;let a=0;for(const n of e)g(n)?a++:s.set(n,(s.get(n)||0)+1);let r=0;const o=[];for(const[n,i]of s)(1===i||3===i)&&(r++,o.push(n));if(r<=a){const e=new p;e.type=n;const i=[];if(a>r)for(let n=1;n<=29;n++)n%10>=1&&n%10<=9&&(s.get(n)||0)<4&&(t[n]||0)>0&&i.push(n);else for(const n of o)(t[n]||0)>0&&i.push(n);e.needCards=i.sort((e,t)=>e-t);let c=0;for(const n of i)c+=t[n]||0;return e.tingCount=c,e.round=0,e}return null}(l,u);t&&e.sevenPairsHits++}(function(e){let t=-1;for(const n of e){if(g(n))continue;const e=Math.floor(n/10);if(!(e>=3))if(-1===t)t=e;else if(t!==e)return!1}return-1!==t})(l)&&(e.singleSuitChecks++,e.singleSuitHits++);const y=A(l,u);if(y.type===i||y.type===c)return e.recordAnalysis(performance.now()-C,l.length),y;if([1,4,7,10,13].includes(l.length))return 13===l.length&&(y.needCards&&y.needCards.length>0?0===y.round||void 0===y.round?y.type=n:y.type=o:y.type=t),y.needCardGroups=[],y.canPlayCards=[],e.recordAnalysis(performance.now()-C,l.length),y;if(0===y.round)return y.type=a,e.recordAnalysis(performance.now()-C,l.length),y;const m=Array(39).fill(0),w=new Set;for(const e of l)g(e)||(m[e]++,w.add(e));const b=function(e,t){if(!e||0===e.length)return e;const n=e.map(e=>{let n=0;const s=e%10,a=t[e]||0,r=e>0&&s>1&&t[e-1]>0,o=e>1&&s>2&&t[e-2]>0,i=s<9&&t[e+1]>0,c=s<8&&t[e+2]>0;return n=r||o||i||c||1!==a?1===s||9===s?80:1===a&&!(r||o)!=!(i||c)?60:2===a?40:1===a&&s>=4&&s<=6?20:a>=3||r&&i?10:30:100,{card:e,score:n}});return n.sort((e,t)=>t.score-e.score),n.map(e=>e.card)}([...new Set([...y.canPlayCards||[],...w])],m);if(b.length>0){const s=[];for(const e of b)if(4===m[e])y.type=c,y.gang=y.gang||[],y.gang.push(e);else if(y.type!==c){const a=[...l],r=a.indexOf(e);a.splice(r,1);const i=[...u];i[e]=Math.min(4,(i[e]||0)+1);const c=A(a,i);let d=0;if(c.needCards&&c.needCards.length>0)for(const e of c.needCards)d+=i[e]||0;c.type===n?c.round=0:c.type===o?0===c.round&&(c.round=1):c.type!==t&&c.needCards&&0!==c.needCards.length||(c.round=99,c.needCards=[],d=0),c.tingCount=d,c.bestPlayCard=e,s.push(c)}if(y.type===c)return y.needCards=y.gang,e.recordAnalysis(performance.now()-C,l.length),y;const a=d.skipDepth?{enableOneShanten:!1}:I();j=0;const i=6,p=function(e){let t=0,n=0,s=0;const a=Array(39).fill(0);for(let r=0;r<=2;r++){const o=10*r;for(let r=1;r<=9;r++){const i=o+r,c=(e[i]||0)-a[i];if(c>=3?(s++,a[i]+=3):c>=2&&(t++,a[i]+=2),r<=8){const t=(e[i]||0)-a[i],s=(e[i+1]||0)-a[i+1];t>=1&&s>=1&&(n++,a[i]++,a[i+1]++)}if(r<=7){const t=(e[i]||0)-a[i],s=(e[i+2]||0)-a[i+2];t>=1&&s>=1&&(n++,a[i]++,a[i+2]++)}}}return s+t+n}(m),g=p>=6;s.sort((e,t)=>{var n,s;const a=null!=(n=e.round)?n:99,r=null!=(s=t.round)?s:99;if(a!==r)return a-r;const o=e.tingCount||0,i=t.tingCount||0;if(o!==i)return i-o;if(g){const n=O(e.bestPlayCard,m),s=O(t.bestPlayCard,m),a=n.breakValue<0;if(a!==s.breakValue<0)return a?-1:1;if(n.breakValue!==s.breakValue)return s.breakValue-n.breakValue;if(n.canCombine!==s.canCombine)return n.canCombine?1:-1}const c=e.needCards?e.needCards.length:0,l=t.needCards?t.needCards.length:0;if(c!==l)return l-c;if(g){const n=O(e.bestPlayCard,m),s=O(t.bestPlayCard,m),a=n.breakValue<0;if(a!==s.breakValue<0)return a?-1:1;if(n.breakValue!==s.breakValue)return s.breakValue-n.breakValue;if(n.canCombine!==s.canCombine)return n.canCombine?1:-1}const u=m[e.bestPlayCard]||0;return(m[t.bestPlayCard]||0)-u});const w=s.length>0&&null!=(f=s[0].round)?f:99,P=s.filter(e=>{var t;return(null!=(t=e.round)?t:99)===w});s.length=0,s.push(...P);const x=s.slice(0,i),S=new Map;for(const e of x){if(1!==e.round||!a.enableOneShanten){e.twoStepExpect=0;continue}const t=e.needCards?[...e.needCards].sort((e,t)=>e-t).join(","):"";if(S.has(t)){const n=S.get(t);e.twoStepExpect=n.twoStepExpect,e.expectDetails=n.expectDetails;continue}const n=[...l],s=n.indexOf(e.bestPlayCard);s>-1&&n.splice(s,1);const r=[...u];r[e.bestPlayCard]=Math.min(4,(r[e.bestPlayCard]||0)+1),e.twoStepExpect=K(n,r,e),S.set(t,{twoStepExpect:e.twoStepExpect,expectDetails:e.expectDetails})}for(let e=i;e<s.length;e++)s[e].twoStepExpect=0;s.sort((e,t)=>{var n,s;const r=null!=(n=e.round)?n:99,o=null!=(s=t.round)?s:99;if(r!==o)return r-o;if(1===r&&a.enableOneShanten){const n=e.twoStepExpect||0,s=t.twoStepExpect||0;if(n!==s)return s-n;const a=e.tingCount||1,r=t.tingCount||1,o=n/a,i=s/r,c=Math.abs(o-i),l=Math.abs(a-r),u=e.needCards?e.needCards.length:0,d=t.needCards?t.needCards.length:0,f=Math.abs(u-d);if(l>=5)return r-a;if(l>=2&&c<.7+.1*f)return r-a;if(c>.1)return i-o;const h=m[e.bestPlayCard]||0,p=m[t.bestPlayCard]||0;if(h!==p)return p-h;const C=v(e.bestPlayCard,m),y=v(t.bestPlayCard,m);if(C!==y)return y-C;if(g){const n=O(e.bestPlayCard,m),s=O(t.bestPlayCard,m);if(n.breakValue!==s.breakValue)return s.breakValue-n.breakValue;if(n.canCombine!==s.canCombine)return n.canCombine?1:-1}}const i=e.tingCount||0,c=t.tingCount||0;if(i!==c)return c-i;if(g){const n=O(e.bestPlayCard,m),s=O(t.bestPlayCard,m),a=n.breakValue<0;if(a!==s.breakValue<0)return a?-1:1;if(n.breakValue!==s.breakValue)return s.breakValue-n.breakValue;if(n.canCombine!==s.canCombine)return n.canCombine?1:-1}const l=e.needCards?e.needCards.length:0,u=t.needCards?t.needCards.length:0;if(l!==u)return u-l;const d=(m[t.bestPlayCard-1]||0)+(m[t.bestPlayCard+1]||0),f=(m[e.bestPlayCard-1]||0)+(m[e.bestPlayCard+1]||0);return d!==f?f-d:Math.abs(t.bestPlayCard%10-5)-Math.abs(e.bestPlayCard%10-5)});const k=[];for(const e of s){const t=new h;t.key=e.bestPlayCard,t.value=[...e.needCards||[]],t.tingCount=e.tingCount||0,t.round=e.round||0,t.twoStepExpect=e.twoStepExpect||0,t.expectDetails=e.expectDetails||[];const n=v(e.bestPlayCard,m,0,!0);t.extendValue=n.value,t.missedDraws=n.missedDraws||[],k.push(t)}y.needCardGroups=k,y.type=r,y.needCardGroups.length>0&&(y.bestPlayCard=y.needCardGroups[0].key)}return e.recordAnalysis(performance.now()-C,l.length),y}class Z{constructor(e=100){this.maxSize=e,this.cache=new Map}has(e){return this.cache.has(e)}get(e){if(!this.cache.has(e))return;const t=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,t),t}set(e,t){if(this.cache.has(e)&&this.cache.delete(e),this.cache.set(e,t),this.cache.size>this.maxSize){const e=this.cache.keys().next().value;this.cache.delete(e)}return this}clear(){this.cache.clear()}get size(){return this.cache.size}}const H=6,$=3,D=new Z(2e3),E=new Z(2e3);let j=0;const G=Object.freeze({enableOneShanten:!0});let R=__spreadValues({},G);function I(){return __spreadValues({},R)}const F={twoStepCalcCount:0,twoStepTotalTime:0,twoStepCacheHits:0,recursionDepthExceeded:0};function N(e,t,s){if(!e)return 0;let r=0;if(e.needCardGroups&&e.needCardGroups.length>0)for(const n of e.needCardGroups)0===n.round&&n.tingCount>r&&(r=n.tingCount);if(0===r){const i=e.type;if(e.round,i===n||i===a)r=e.tingCount||0;else if(i===o&&t&&s){const e=[...new Set(t.filter(e=>!g(e)))],a=new Set;for(const o of e){const e=t.indexOf(o);if(-1===e)continue;const i=[...t];i.splice(e,1);const c=[...i].sort((e,t)=>e-t).join(",");if(a.has(c))continue;a.add(c);const l=[...s];l[o]=Math.min(4,(l[o]||0)+1);const u=c+"|"+o;if(E.has(u)){const e=E.get(u);e>r&&(r=e);continue}const d=A(i,l);let f=0;if(0===d.round||d.type===n){if(d.needCards)for(const e of d.needCards)f+=l[e]||0;f>r&&(r=f)}E.set(u,f)}}}return r}function B(e,t,n,s){e.push(n);const a=t[n];t[n]=Math.max(0,a-1);try{return s()}finally{e.pop(),t[n]=a}}function K(e,t,n){if(!Array.isArray(e)||!Array.isArray(t)||!n)return 0;if(1!==n.round)return 0;const s=n.needCards||[];if(0===s.length)return 0;if(!(j<$))return F.recursionDepthExceeded++,0;const a=function(e,t,n=null){const s=[...e].sort((e,t)=>e-t).join(",");let a="";if(n&&n.length>0)a=n.filter(e=>e>=0&&e<t.length).map(e=>`${e}:${t[e]||0}`).join(";");else{let e=0;for(let n=1;n<38;n++)t[n]>0&&(e=(31*e+t[n]*n)%1000000007);a=String(e)}return`${s}|${a}`}(e,t,s);if(D.has(a)){F.twoStepCacheHits++;const e=D.get(a);return e&&"object"==typeof e?(n.expectDetails=e.details,e.value):e}const r=performance.now();j++;try{let r=0;const o=function(e,t,n){return e.map(e=>({card:e,count:t&&e>=0&&e<t.length&&t[e]||0})).filter(e=>e.count>0).sort((e,t)=>t.count-e.count).slice(0,n)}(s,t,H),i=[...e],c=[...t];let l=0;const u=[];for(const{card:e,count:t}of o){const n=B(i,c,e,()=>N(A(i,c),i,c)),s=t*n;u.push({card:e,count:t,tingCount:n,contribution:s}),n>0&&(r+=s,l++)}n.expectDetails=u;const d=r;return D.set(a,{value:d,details:u}),d}finally{j--,F.twoStepCalcCount++,F.twoStepTotalTime+=performance.now()-r}}function U(e){return{not_ready:"无法胡牌",ready:"听牌",xiaoxianggong:"小相公",winning:"已胡牌",unknown:"未知状态"}[e]||"未知状态"}function q(e){const t=(e.value||[]).length,n=e.tingCount||0,s=e.round||0,a=e.twoStepExpect||0;return s>=2?`${s}向听，进张${t}门${n}张`:1===s&&a>0?`1向听，进张${n}张，期望${a}`:0===s?`听${t}门${n}张`:`${s}向听，进张${t}门${n}张`}function J(e,l=!1,u="loji"){const d=function(e){switch(e){case t:case i:return"not_ready";case n:case r:case o:case c:return"ready";case s:return"xiaoxianggong";case a:return"winning";default:return"unknown"}}(e.type);return{status:d,statusCode:e.type,statusText:U(d),tingCards:e.needCards||[],tingCount:e.tingCount||0,recommendations:(f=e.needCardGroups||[],f&&0!==f.length?f.map((e,t)=>({id:t+1,discardTile:e.key,waitingTiles:e.value||[],waitingCount:e.tingCount||0,round:e.round||0,twoStepExpect:e.twoStepExpect||0,expectDetails:e.expectDetails||[],extendValue:e.extendValue||0,missedDraws:e.missedDraws||[],priority:t+1,description:q(e)})):[]),gangCards:e.gang||[],metadata:{round:e.round||0,originalType:e.type,algorithm:u,cached:l,timestamp:Date.now(),canPlayCards:e.canPlayCards||[]}};var f}const L=new class{constructor(e=2e3){this.cache=new Map,this.maxSize=e}getCacheKey(e){return[...e].sort((e,t)=>e-t).join(",")}get(e){const t=this.getCacheKey(e);return this.cache.get(t)}set(e,t){const n=this.getCacheKey(e);if(this.cache.size>=this.maxSize){const e=this.cache.keys().next().value;this.cache.delete(e)}this.cache.set(n,__spreadProps(__spreadValues({},t),{cached:!0,timestamp:Date.now()}))}clear(){this.cache.clear()}};self.onmessage=function(e){var t,n;const{id:s,type:a,payload:r}=e.data;try{switch(a){case"analyze":{const{cards:e,cardMap:a,useCache:o}=r;I();if(!1!==o){const t=L.get(e);if(t)return void self.postMessage({id:s,type:"result",payload:J(t,!0,"loji-worker")})}const i=V(e,a);if((null==(t=i.needCardGroups)?void 0:t.length)>0){const e=i.needCardGroups[0];0===e.tingCount&&(null==(n=e.value)||n.length)}!1!==o&&L.set(e,i),self.postMessage({id:s,type:"result",payload:J(i,!1,"loji-worker")});break}case"clearCache":L.clear(),self.postMessage({id:s,type:"result",payload:{success:!0}});break;case"setSettings":{const{settings:e}=r;!function(e){"object"==typeof e&&null!==e&&(R=Object.freeze({enableOneShanten:"boolean"==typeof e.enableOneShanten?e.enableOneShanten:R.enableOneShanten}))}(e);const t=I();self.postMessage({id:s,type:"result",payload:{success:!0,settings:t}});break}default:throw new Error(`Unknown message type: ${a}`)}}catch(o){self.postMessage({id:s,type:"error",payload:{message:o.message,stack:o.stack}})}},self.postMessage({type:"ready"})}();
